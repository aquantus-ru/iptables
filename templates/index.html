{% extends "base.html" %}

{% block content %}
      <h1>Iptables Manager</h1>

      {% if not tables %}
        <div class="alert alert-warning">No iptables data found.</div>
      {% else %}

        <ul class="nav nav-tabs" id="tableTabs" role="tablist">
          {% for table_name in tables.keys() %}
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}" id="{{ table_name }}-tab" data-bs-toggle="tab" data-bs-target="#{{ table_name }}" type="button" role="tab" aria-controls="{{ table_name }}" aria-selected="true">{{ table_name }}</button>
          </li>
          {% endfor %}
        </ul>

        <div class="tab-content" id="tableTabsContent">
          {% for table_name, table_data in tables.items() %}
          <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ table_name }}" role="tabpanel" aria-labelledby="{{ table_name }}-tab">
            <div class="table-container p-3 border border-top-0">

              <h3>Table: {{ table_name }}</h3>

              {% for chain_name, chain_data in table_data.chains.items() %}
              <div class="chain-section">
                <div class="chain-header d-flex justify-content-between align-items-center">
                  <span><strong>Chain {{ chain_name }}</strong> (Policy: {{ chain_data.policy }})</span>
                  <span class="badge bg-secondary">{{ chain_data.counters }}</span>
                </div>

                <table class="table table-striped table-hover mt-2">
                  <thead>
                    <tr>
                      <th>Rule</th>
                      <th>Parsed Options</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% set ns = namespace(found=false) %}
                    {% for rule in table_data.rules %}
                      {% if rule.chain == chain_name %}
                        {% set ns.found = true %}
                        <tr>
                          <td class="rule-row">{{ rule.full_line }}</td>
                          <td>
                            {% for k, v in rule.options.items() %}
                              {% if v %}
                                <span class="badge bg-info text-dark">{{ k }}: {{ v }}</span>
                              {% endif %}
                            {% endfor %}
                          </td>
                          <td>
                              <!-- Placeholder for delete/edit -->
                              <button class="btn btn-sm btn-danger" disabled>Delete</button>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                    {% if not ns.found %}
                      <tr><td colspan="3" class="text-muted">No rules in this chain.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
              {% endfor %}

            </div>
          </div>
          {% endfor %}
        </div>

      {% endif %}
{% endblock %}
